## 心跳连接与状态监控方案（QNotes）
Date:2025.11.11
### 背景与目标
- 可观察两类状态：网络可达性（Network）与鉴权有效性（Auth）。
- 保持极轻量的服务器负担：零数据库访问、204 空响应、低频率、页面不可见降频、失败指数退避。
- 发生状态变化时，前端以指示灯直观展示，不打断用户操作。

### 服务端改动
- 新增接口（均无副作用、无 DB 操作）：
  - GET `/healthz`
    - 无需鉴权；用于纯网络连通性探测。
    - 响应：204；响应头：`Cache-Control: no-store`。
  - GET `/api/auth/ping`
    - 需 Bearer JWT；仅通过 `authenticate` 做 JWT 验签与过期校验。
    - 响应：204（通过）、401/403（无效）。
    - 响应头：`Cache-Control: no-store`。
- 代码位置：`src/server.js`
  - `/healthz` 在静态资源中间件之后、兜底路由之前。
  - `/api/auth/ping` 复用现有 `authenticate` 中间件。

### 前端改动
- 新增状态与心跳调度（`public/app.js`）：
  - 状态：
    - `netOnline`: 是否网络可达（初值 `navigator.onLine`）。
    - `authValid`: 鉴权是否有效（初值取决于是否存在 `authToken`）。
  - 心跳与频率（页面可见/不可见）：
    - 网络心跳：`GET /healthz`
      - 可见：每 15 秒；不可见：每 60 秒；超时 3 秒。
      - 失败指数退避：倍增至上限 5 分钟。
    - 鉴权心跳：`GET /api/auth/ping`
      - 仅在 `netOnline === true` 且存在 `authToken` 时执行。
      - 可见：每 60 秒；不可见：每 5 分钟；超时 4 秒。
      - 失败指数退避：倍增至上限 10 分钟；401/403 视为鉴权失效（不退避，保持较短探测）。
  - 事件联动：
    - `request()` 封装：遇网络错误→`netOnline=false`；401/403→`authValid=false`。
    - `window.online/offline`：即时更新网络状态并重置心跳调度。
    - `visibilitychange`：可见性变化时重置当前心跳间隔（降频/升频）。
  - 启动：在 `initializeApp()` 中调用 `startHeartbeat()`。

### UI 指示
- 新增两个指示灯与文案（`public/index.html` 顶部 Header）：
  - 网络：元素 `#net-dot` + `#net-text`
  - 鉴权：元素 `#auth-dot` + `#auth-text`
- 样式（`public/styles.css`）：
  - 容器：`.conn-indicators`/`.conn-item`
  - 状态点：`.conn-dot` + 状态类 `.ok`、`.warn`、`.error`、`.offline`
  - 文案：`.conn-text`
- 显示逻辑（摘要）：
  - 网络：`ok`=网络可达，`offline`=不可达。
  - 鉴权：在网络可达且持有 token 时判定：`ok`=有效，`error`=失效；否则置灰 `offline`。

### 失败与边界处理
- 网络错误（超时/断网）：标记 `netOnline=false`，网络指示为离线；心跳进入退避，页面可见时仍保持较短探测。
- 鉴权失效（401/403）：标记 `authValid=false`，鉴权指示为错误；不强制跳转，提示由现有逻辑决定（当前 `tryAutoLogin()` 首次进入时仍按照既有行为处理）。
- 成功调用任一受保护 API（非 `/auth/ping`）可视作鉴权有效一次（为了减少额外心跳依赖）。

### 负载与可扩展性
- 两个新接口均为 204、零负载（无 DB），默认频率很低；页面不可见自动降频；失败指数退避。
- 大量客户端同时异常时，通过退避显著削峰。
- 后续可将心跳间隔/超时配置化（例如来自 `localStorage` 或构建参数），当前为常量：
  - 网络：可见 15s / 隐藏 60s / 超时 3s / 上限 5min
  - 鉴权：可见 60s / 隐藏 5min / 超时 4s / 上限 10min

### 变更清单
- `src/server.js`
  - 新增 `GET /healthz`
  - 新增 `GET /api/auth/ping`（挂 `authenticate`）
- `public/index.html`
  - Header 中添加网络/鉴权指示元素
- `public/styles.css`
  - 指示器容器与状态点样式
- `public/app.js`
  - 心跳调度、状态更新、事件联动与 UI 更新

### 验收与测试
1) 正常联网、已登录：
   - 网络指示为绿色“网络正常”；鉴权指示为绿色“鉴权有效”。
2) 断网（或阻断 `/healthz`）：
   - 网络指示变为灰“网络不可用”；鉴权指示变为灰“无法校验”或“未登录”。
3) 使 token 过期（或删除 `Authorization`）：
   - 鉴权心跳返回 401/403 后，鉴权指示变为红“鉴权失效”。
4) 切换到后台（标签页不可见）：
   - 心跳频率自动降为隐藏模式频率；回到前台恢复。
5) 产生请求错误（如服务器临时 5xx）：
   - 不影响 `/healthz` 的结果；鉴权在非 401/403 错误时采用退避。

### 兼容性
- 改动对现有 API 与页面行为无破坏性；指示器为附加 UI，不影响主体功能。
- 心跳为轻量 GET 调用，不与当前保存/锁定逻辑冲突。


