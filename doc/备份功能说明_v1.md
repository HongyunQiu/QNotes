## 数据备份功能说明（v1）

### 概述
为管理后台新增“数据备份”能力，可将以下目录打包为单一 zip 文件下载：
- `data/**`（SQLite 数据库，如 `data/qnotes.db`）
- `public/uploads/**`（用户上传的图片、附件等）
- `public/vendor/**`（通过 CDN/本地引入的 Editor.js 插件等）

备份过程中，前端展示实时进度（近似），避免长期无反馈导致用户焦虑。

### 运行依赖
- 新增依赖：`archiver@^6.0.1`（用于 zip 打包）
- 启动/安装：
```bash
npm install
npm start
```

### 后端接口
- 路径：`GET /api/admin/backup`
- 权限：仅管理员用户可访问（`authenticate` + `requireAdmin`）
- 响应：
  - `Content-Type: application/zip`
  - `Content-Disposition: attachment; filename="qnotes-backup-YYYYMMDD-HHMMSS.zip"`
  - `X-Source-Bytes: <number>` 源目录总字节数（近似，用于前端进度显示）
  - zip 内额外包含 `backup-meta.json`，记录生成时间与包含目录：
    ```json
    {
      "generatedAt": "<ISO 时间>",
      "include": ["data/**", "public/uploads/**", "public/vendor/**"]
    }
    ```

实现位置：`src/server.js` 中 `/api/admin/backup` 路由。

### 前端 UI 与交互
- 文件：
  - `public/admin.html`：在“数据备份”卡片中新增按钮、状态行、进度条
    - 元素 id：`backup-btn`、`backup-status`、`backup-progress`、`backup-progress-bar`
  - `public/admin.js`：新增 `downloadBackup()`，以流式读取响应体，实现进度展示与下载触发。

- 行为：
  - 点击“下载备份”后，按钮与状态文字变化：
    - “准备中…” → “打包中… X%” → “打包完成，保存中…”
  - 进度条动态增长：
    - 依据已接收字节数与 `X-Source-Bytes` 近似比值计算（上限约 99%，完成后置为 100%）
  - 兼容性：若浏览器不支持 `ReadableStream`，退化为整体 `blob()` 下载，无实时进度但功能正常。

### 使用方法
1. 管理员登录后进入管理后台（`/public/admin.html`）。
2. 在“数据备份”卡片点击“下载备份”。
3. 观察进度条与状态文字，完成后保存 zip 文件。

### 恢复建议（手动）
1. 停止服务（避免数据库被占用/锁定）。
2. 解压 zip，按原路径结构覆盖至项目根目录：
   - 将解压得到的 `data/`、`public/uploads/`、`public/vendor/` 拷贝回对应位置。
3. 启动服务：`npm start`。

注意：
- 建议恢复时确保 `data/qnotes.db` 未被任何进程占用。
- 该备份不包含 `node_modules/`、环境变量文件（如 `.env`）与运行时进程状态。请按需单独备份这些内容。

### 常见问题
- 端口被占用（EADDRINUSE）：说明已有实例在运行。请结束旧进程或设置 `PORT` 使用其他端口后启动。
- 进度显示与真实压缩时间不一致：`X-Source-Bytes` 为近似估算值，压缩耗时受文件类型、大小与机器性能影响，进度仅供参考。
- 下载被浏览器或杀毒软件拦截：请将下载 zip 加入白名单或使用可信浏览器环境。

### 变更摘要
- 后端：
  - 新增 `archiver` 依赖。
  - 增加 `GET /api/admin/backup` 路由；计算源目录估算大小，设置 `X-Source-Bytes`，流式输出 zip。
- 前端：
  - `admin.html`：新增“数据备份”卡片（按钮、状态、进度条）。
  - `admin.js`：实现 `downloadBackup()`，使用 `ReadableStream` 实时更新进度；完成后触发保存。


