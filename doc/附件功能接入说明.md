QNotes 附件功能接入说明
=======================

概述
----

本次变更为 Editor.js 集成 `@editorjs/attaches` 附件工具，支持在笔记中插入并保存任意文件的“附件”区块。上传的文件存储于服务端 `public/uploads/`，前端内容以 Editor.js 区块数据形式持久化至数据库。

前端改动
--------

- 在 `public/index.html` 引入插件 CDN：

  ```html
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/attaches@latest"></script>
  ```

- 在 `public/app.js` 的 `setupEditor()` 中注册工具：

  ```javascript
  attaches: {
    class: (window.AttachesTool || window.Attaches),
    config: {
      endpoint: `${API_BASE}/uploadAttachment`,
      field: 'file',
      buttonText: '选择文件',
      errorMessage: '文件上传失败',
      additionalRequestHeaders: authToken ? { Authorization: `Bearer ${authToken}` } : {}
    }
  }
  ```

- 允许加载/保存 `attaches` 区块类型（读取时的白名单过滤已包含 `attaches`）：

  ```javascript
  block.type === 'attaches'
  ```

后端改动
--------

- 新增附件上传接口（字段名为 `file`，返回与插件兼容的响应）：

  - 路由：`POST /api/uploadAttachment`
  - 鉴权：需要 `Authorization: Bearer <token>`
  - 表单字段：`file`
  - 返回：

    ```json
    {
      "success": 1,
      "file": {
        "url": "/uploads/<filename>",
        "name": "<originalName>",
        "size": 12345,
        "extension": "pdf"
      }
    }
    ```

- 上传策略：沿用既有 `multer` 磁盘存储至 `public/uploads/`，并返回可公开访问的相对 URL。

使用方法
--------

1. 在编辑器工具栏中选择“附件/Select file”。
2. 选择本地文件后自动上传并插入一个附件区块，显示文件名与大小。
3. 保存笔记后，区块数据随笔记内容一同持久化。

数据格式
--------

`attaches` 区块的典型存储结构如下（示例）：

```json
{
  "type": "attaches",
  "data": {
    "file": {
      "url": "/uploads/1730000000-abcd12.pdf",
      "size": 23456,
      "name": "示例文档.pdf",
      "extension": "pdf"
    },
    "title": "示例文档"
  }
}
```

注意事项与建议
--------------

- 鉴权：上传接口要求 JWT 鉴权；前端通过 `additionalRequestHeaders` 自动附加 `Authorization` 头。
- 类型限制：如需限制可上传的文件类型，可在前端配置 `types`（MIME）并在后端增加校验逻辑。
- 大小限制：可在 `multer` 或反向代理层设置大小限制，防止超大文件占用资源。
- 静态访问：文件通过 `/uploads/*` 由静态资源中间件直接提供；若需权限控制，可改造为受控下载接口。

涉及文件
--------

- `public/index.html`：引入 `@editorjs/attaches` 脚本。
- `public/app.js`：注册 `attaches` 工具、补充区块白名单。
- `src/server.js`：新增 `POST /api/uploadAttachment` 附件上传接口。

参考链接
--------

- Editor.js Attaches 插件文档：`https://github.com/editor-js/attaches`


