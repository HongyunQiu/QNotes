## 管理后台功能总结（QNotes）

### 背景与目标
- 为 QNotes 增加仅超级管理员可访问的“管理后台”页面，提供基础运维视图：用户查看、数据库概览、表结构查看。

### 实现概述
- 数据库
  - 在 `users` 表新增 `is_admin INTEGER NOT NULL DEFAULT 0` 列。
  - 迁移策略：若库内尚无管理员，会自动将“最早的一个用户”提升为管理员。
  - 对旧库做安全迁移（PRAGMA 检查后按需 `ALTER TABLE`）。

- 后端（Express, `src/server.js`）
  - JWT 载荷新增 `is_admin`；`/api/profile` 返回 `id, username, is_admin`。
  - 新增 `requireAdmin` 中间件（基于数据库读取实时判断）。
  - 管理接口（管理员专用）：
    - `GET /api/admin/users`：列出用户，含是否管理员与笔记数。
    - `GET /api/admin/db/summary`：返回用户数、笔记数、数据库大小（bytes）。
    - `GET /api/admin/db/tables`：返回 `users` 与 `notes` 的表结构（PRAGMA）。

- 前端（Vanilla JS, `public/`）
  - 新增 `public/admin.html`、`public/admin.js`：
    - 顶部操作：返回应用、退出登录。
    - 卡片：数据库概览、用户列表（角色、笔记数）、表结构信息。
  - 在主应用 `public/app.js` 中：登录成功后如检测到 `is_admin=true`，在右上角插入“管理”入口链接。

### 使用与验证
- 运行：
  - 安装依赖：`npm install`
  - 启动：`npm start`（可用环境变量：`PORT`、`DB_FILE`、`JWT_SECRET`）。
  - 打开：`http://localhost:3000/`

- 管理入口：
  - 登录管理员账号后，右上角会出现“管理”按钮；或直接访问 `http://localhost:3000/admin.html`。

- 初始管理员策略：
  - 新库或迁移后的旧库中，如不存在任何管理员，将自动把“ID 最小的用户”提升为管理员。
  - 如需手动设定管理员：将目标用户的 `is_admin` 置为 `1`。示例（SQLite）：
    - `UPDATE users SET is_admin = 1 WHERE username = 'your_user';`

### 接口清单（新增）
- `GET /api/admin/users`（管理员）
- `GET /api/admin/db/summary`（管理员）
- `GET /api/admin/db/tables`（管理员）

### 注意事项
- 若登录后仍未显示“管理”入口：
  - 确认后端已重启并加载新代码（`/api/profile` 返回应包含 `is_admin`）。
  - 确认当前进程使用的数据库（`DB_FILE`）即为设置过管理员的那份。
  - 重新登录或强制刷新，以确保前端读取到最新的 `profile`。

### 变更文件一览
- 新增：
  - `public/admin.html`、`public/admin.js`
  - 本文档：`doc/管理后台功能总结.md`
- 修改：
  - `src/db.js`：新增 `is_admin` 列、迁移与初始管理员逻辑。
  - `src/server.js`：JWT/`/api/profile` 携带 `is_admin`，新增 `requireAdmin` 与管理员接口。
  - `public/app.js`：登录后根据 `is_admin` 显示“管理”入口。

### 后续可拓展
- 管理端操作：用户升/降级、用户禁用与密码重置、数据库维护（VACUUM、导出/备份）。
- 统计与监控：活跃度、最近编辑、存储增长趋势。


