截止到版本日期2025.11.4 
我已快速通读后端与数据库/上传相关实现，重点看了静态资源暴露、上传与抓取逻辑、备份导出以及数据库文件位置。
结论（摘要）
数据库文件默认不在对外可见目录下，直接被外部下载的风险较低；但提供了“管理员备份下载”接口，若管理员账户或 JWT 秘钥被攻破，数据库可被导出。
附件保存于对外可访问目录，任何知道 URL 的人都可下载；上传与 URL 抓取缺少类型/大小限制与内容安全措施，存在 XSS、SSRF、磁盘耗尽等风险。建议按优先级尽快收敛。
关键证据（代码定位）
静态目录指向 public/：
app.use(express.json({ limit: '2mb' }));app.use(express.static(path.join(__dirname, '..
上传目录位于 public/uploads/ 且直接写入：
const UPLOAD_DIR = path.join(__dirname, '..', 'public', 'uploads');if (!fs.existsSync(UPLOAD_DIR)) {  fs.mkdirSync(UPLOAD_DIR, { recursive: true });}// multer: destination = UPLOAD_DIR, filename = 时间戳+随机串+扩展名
上传接口返回可公开访问的 URL（无需下载鉴权）：
app.post('/api/uploadFile', authenticate, upload.single('image'), (req, res) => {  const publicUrl = `/uploads/${req.file.filename}`;  res.json({ success: 1, file: { url: publicUrl, name: req.file.originalname, size: req.file.size } });});app.post('/api/uploadAttachment', authenticate, upload.single('file'), (req, res) => {  const publicUrl = `/uploads/${req.file.filename}`;  // ...  res.json({ success: 1, file: { url: publicUrl, name, size, extension: ext } });});
URL 抓取下载（仅限 http/https），直接落盘至 public/uploads/，未做大小/IP 段限制：
app.post('/api/fetchUrl', authenticate, async (req, res) => {  const parsed = new URL(url);  if (!/^https?:$/.test(parsed.protocol)) return res.status(400).json({ error: 'Only http/https is allowed' });  const client = parsed.protocol === 'https:' ? https : http;  // 推断扩展名 → 直接以流写入 uploads（无尺寸上限/超时/网段校验）  const fileStream = fs.createWriteStream(filepath);  resp.pipe(fileStream);  // 返回 /uploads/<filename>});
数据库文件位置默认在非静态目录 data/ 下：
const dbFile = process.env.DB_FILE || path.join(__dirname, '..', 'data', 'qnotes.db');const db = new Database(dbFile);
管理员备份接口会打包 data/（含数据库）+ public/uploads/ 并下载：
app.get('/api/admin/backup', authenticate, requireAdmin, async (req, res) => {  const dataDir = path.join(ROOT, 'data');  const uploadsDir = path.join(ROOT, 'public', 'uploads');  // ...
if (fs.existsSync(dataDir)) {  archive.directory(dataDir, 'data');}if (fs.existsSync(uploadsDir)) {  archive.directory(uploadsDir, path.join('public', 'uploads'));}
数据库文件安全性评估
要点
默认路径 data/qnotes.db 不在静态目录，外部不可直接访问（正面）。
存在“管理员备份下载”接口，认证通过且需管理员权限（正面），但一旦管理员账户或 JWT 配置薄弱被攻破，数据库可被完整导出（风险）。
环境变量 DB_FILE 若误配至 public/ 内，会被静态服务器直接暴露（配置风险）。
风险级别
中等（取决于运维与鉴权强度）。
建议
强制在生产设置强随机 JWT_SECRET，并定期轮换。
管理员账户启用强密码/二次校验（运维层面），最小化管理员数量。
为备份接口添加审计日志与限流，必要时仅允许内网访问或加 IP 白名单。
通过启动自检拒绝 DB_FILE 指向 public/ 的配置；或运行时校验并报错。
生产环境落盘在受保护磁盘（加密卷）与受控备份路径，控制备份保留与访问。
附件文件安全性评估
存储与访问控制
上传存于 public/uploads/，静态直出；下载无需鉴权。URL 被知道即可获取（默认无目录索引，但可被外链/泄露）（隐私风险：中等）。
文件类型与内容风险
未做服务端类型白名单/验证与“强制下载”处理。可上传 .html/.svg 等富内容，同源静态直出，存在 XSS/脚本植入与钓鱼风险（高）。
未设置 X-Content-Type-Options: nosniff、不强制 Content-Disposition: attachment，浏览器将按扩展名执行渲染（放大风险）。
尺寸与资源消耗
multer 未设置 limits，可大文件上传（DoS/磁盘耗尽风险：中等-高，取决于前置代理与磁盘监控）。
/api/fetchUrl 未限制单文件大小/下载时长/重定向/并发/网段；可被用于拉取超大文件或大流量消耗资源（DoS 风险：高）。
SSRF（服务器端请求伪造）
/api/fetchUrl 仅检查协议为 http/https，未阻断 127.0.0.1、169.254.169.254、内网/环回/链路本地等网段，存在 SSRF 访问内网资产或云元数据的可能（高）。
文件名与碰撞
存储文件名采用 时间戳 + 6位随机串 + 扩展名，碰撞概率低；不使用原始文件名用于落盘（正面）。
清理与治理
未见孤儿附件清理/生命周期管理；长期运行会膨胀（运营风险：中等）。
优先级建议（不改代码，仅给策略）
高优先（安全阻断）
为 /api/fetchUrl 增加严格网段阻断（拒绝本地回环、私有网段、云元数据 IP 等）、大小与时长上限、重定向跳转次数限制、MIME 白名单与超时；必要时启用下载代理服务做隔离。
上传仅允许必要类型（至少禁止 .html/.svg/可执行脚本），或所有下载一律以 attachment 方式返回并加 nosniff，避免浏览器渲染执行。
为上传与抓取设置合理大小/并发/速率/配额限制与错误审计，配合磁盘告警。
中优先（收敛暴露面）
如业务允许，将附件改为“受控下载接口 + 签名 URL/权限校验/短期有效期”，避免长期公网直出。
若必须静态直出，考虑将上传域名与站点域名分离，置于独立二级域并隔离 Cookie，降低同源脚本风险。
运营与合规
建立附件清理策略（删除笔记时删除引用文件；定期清理未引用/过期文件）。
对上传内容做安全扫描（如杀软/ClamAV）与扩展名-魔数一致性校验。
备份访问加审计、限流、来源限制；对备份文件进行加密与安全存储。
—
我已完成后端相关实现的代码审阅，定位了数据库与附件的存储与暴露路径以及备份导出逻辑，并给出按风险优先级的改进建议。
