QNotes 权限与可见性说明（2025-11）
================================

本文档概述当前项目的“读取可见性 + 写入控制”策略、运行模式与相关实现位置，便于维护与扩展。

### 模式概览

- 个人笔记模式（personal）：
  - 所有人（包含超级管理员）只能看到“自己创建”的笔记。
  - 搜索、关键字索引、笔记树与单篇查看均会严格过滤到“仅本人笔记”。
  - 创建子笔记时，父节点必须属于自己；移动时，目标父节点也必须属于自己。

- 团队协作模式（team）：
  - 任何用户（包含超级管理员）仅能看到：自己的笔记 + 由“管理员用户”创建的笔记（视为公共笔记）。
  - 因此管理员用户最终也只能看到“管理员创建”的公共笔记（通常就是自己创建的笔记）。
  - 创建子笔记时，父节点必须属于自己或属于管理员；移动时，目标父节点也必须属于自己或属于管理员。

### 写入权限（两种模式一致）

- 写入（更新、删除、移动、加锁/解锁）需要“笔记拥有者本人或管理员”。
- 解锁：管理员可以解锁非本人持有的锁（用于处理异常占用）。

### 服务端实现要点

- 核心文件：`src/server.js`
- 认证：Bearer JWT（`Authorization: Bearer <token>`），中间件 `authenticate`
- 角色：
  - 管理员判定：`isAdminUser(req)`、`isAdminId(userId)`
  - 写入控制中间件：`requireNoteWriteAccess`（仅允许“笔记所有者 or 管理员”）
- 模式读取：`getAuthMode()`（来自 `settings.auth_mode`，取值 `personal` 或 `team`）

可见性过滤（读取接口均已内置过滤）：
- `GET /api/notes`：返回的树已按当前模式过滤
- `GET /api/notes/:id`：拒绝访问不可见的笔记（403）
- `GET /api/keywords`：仅统计可见笔记的关键词
- `GET /api/search`：仅返回可见笔记的搜索结果
- `POST /api/notes`：校验父节点是否对当前用户可见（personal：父必须属于自己；team：父属于自己或管理员）
- `POST /api/notes/:id/move`：校验目标父节点是否对当前用户可见（与创建规则一致）

写入控制（与可见性无关，统一生效）：
- `PUT /api/notes/:id`
- `DELETE /api/notes/:id`
- `POST /api/notes/:id/move`
- `POST /api/notes/:id/lock`
- `POST /api/notes/:id/unlock`（管理员可越权解锁）

### 管理端（Admin）

- 界面文件：`public/admin.html`，逻辑：`public/admin.js`
- 仅管理员可访问管理员页面与接口。
- 可配置项：
  - 授权模式切换：`GET/POST /api/admin/settings`（`auth_mode`）
  - 组与成员、二级节点授权界面仍保留用于未来扩展；当前“团队协作模式”的可见性策略已改为“仅本人 + 管理员创建的笔记”，未再依赖这些分组规则。

### 数据库结构

- 文件：`src/db.js`
- 主要表：
  - `users(id, username, password_hash, is_admin, created_at)`
  - `notes(id, parent_id, title, content, content_text, keywords, owner_id, updated_at, lock_user_id, lock_expires_at)`
  - `settings(key, value)`：保存 `auth_mode`（`personal` / `team`）
  - 以下表为后续拓展保留，当前团队模式的可见性未使用：
    - `groups(id, name)`
    - `user_groups(user_id, group_id)`
    - `section_group(section_note_id, group_id)`

### 安全与注意事项

- JWT 过期与校验失败会返回 401；管理员接口均需 `requireAdmin`。
- 请避免在接口层绕过已有过滤逻辑；新增读取接口时务必参照以上模式规则进行可见性过滤。
- 管理员不再拥有“查看所有人笔记”的特权：
  - personal：管理员与普通用户一致，只能看自己的
  - team：管理员与普通用户一致，只能看“自己 + 管理员创建的笔记”（通常即自己）

### 未来扩展建议

- 若需恢复“按二级节点分组授权”的团队模式，可将可见性过滤切换为 `section_group`/`user_groups` 规则，并调整管理员可见范围策略。
- 可考虑将“公共笔记”的定义从“管理员创建”扩展为“标记公共”的属性字段，以提升灵活性。

### 管理员在二级节点权限控制下的权限分析

- 可见性（Team 模式）
  - 管理员与普通用户相同，无“查看所有人笔记”的特权。
  - 管理员可见内容 = 自己创建的所有笔记 + 位于“管理员拥有的二级节点”且对管理员所属组已授权（或未分配=公开）的笔记。
  - 管理员不可见：其他用户的个人笔记（不在管理员二级节点下），以及未对管理员所属组授权的管理员二级节点内容。
  - 单篇访问：命中不可见范围则 403；树中仅为结构承载包含“管理员拥有的根”，直接访问未授权根仍拒绝。

- 写入权限（两种模式一致）
  - 管理员可对任何已存在的笔记进行更新/删除/移动/加锁/解锁（越权写），用于维护与故障处理。
  - 但“创建子笔记/移动笔记”的目标父节点必须对管理员可见：
    - personal：父必须属于管理员本人；
    - team：父属于管理员本人，或位于管理员被授权（或未分配=公开）的管理员二级节点下。

- 授权对象范围
  - 仅“管理员拥有的二级节点”参与授权；普通用户的二级节点不出现在授权面板，也不需要授权。

- 多管理员场景
  - 管理员 A 不会自动看到管理员 B 的二级节点内容，除非该二级节点“公开”或分配给管理员 A 所属组。
  - 管理员未加入任何组时，只能看到“公开”的管理员二级节点内容与自己创建的笔记。

- 结果与边界
  - 管理员读权限遵循与普通用户相同的可见性过滤；写权限对现有笔记保留越权（可更新/删除等）。
  - 若未来需要“管理员总览所有管理员二级节点”的能力，需调整当前可见性逻辑（目前未启用）。


