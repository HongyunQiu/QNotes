QNotes 全局搜索 v1 实现说明
===========================

目标与范围
---------

- 范围：支持检索笔记的标题、正文（Editor.js 内容）、关键词/标签、附件文件名。
- 方式：后端使用 SQLite 普通 LIKE 检索，前端提供全局搜索面板（Ctrl/⌘+K）。

数据模型与存储
--------------

- 新增字段：`notes.content_text TEXT NOT NULL DEFAULT ''`。
  - 含义：将 Editor.js 的结构化 JSON 摊平成可检索的纯文本，同时合并关键词文本，便于 LIKE 查询。
- 回填策略：服务启动时对 `content_text` 为空的历史记录进行一次性回填。
- 保存策略：在保存笔记 `/api/notes/:id (PUT)` 时实时更新 `content_text`。

Editor.js JSON 摊平策略（提取实质性内容）
----------------------------------------

- 统一做法：去除 HTML 标签、实体还原、合并空白，忽略仅用于显示/布局的辅助字段。
- 各工具处理：
  - header：提取 `data.text`
  - paragraph：提取 `data.text`
  - quote：提取 `data.text` 与 `data.caption`
  - checklist：提取 `data.items[].text`
  - image：提取 `data.caption`、`data.file.url` 的文件名
  - code：提取 `data.code`
  - mermaid：提取 `data.code`
  - attaches：提取 `data.file.name` 与 `data.file.url` 的文件名
  - warehouse：若存在，提取 `data.title`、`data.description`
- 附件文件名提取：对 `url` 取路径最后一段作为文件名，忽略查询串/锚点。
- 关键词合并：将关键词数组 join 后拼接到 `content_text` 尾部，增强命中。

后端 API
--------

- 接口：`GET /api/search`（需要认证）
  - 入参（Query）：
    - `q`：搜索词（必填）
    - `limit`：每页数量，默认 20，最大 50
    - `offset`：偏移量，默认 0
  - 命中范围：`title`、`content_text`、`keywords` 三列（LIKE `%q%`）
  - 排序：`updated_at DESC`
  - 返回：
    - `total`：总条数
    - `items[]`：包含 `id`、`title`、`updated_at`、`matchFields`（命中的字段集合）与 `snippet`
  - `snippet` 说明：后端在首个命中附近截取上下文，并用占位符 `<<...>>` 包裹命中片段，前端转为 `<mark>` 高亮。

安全与性能
----------

- 使用参数化查询防注入；限制 `limit`（<=50）与 `offset` 合理范围。
- 前端输入防抖 300ms；结果文本进行 `escapeHtml` 转义，避免 XSS。
- 仅返回必要字段，`snippet` 在后端生成，前端只负责安全渲染。

前端 UI/交互
------------

- 顶栏新增“搜索”按钮与快捷键：Ctrl/⌘+K 打开、Esc 关闭。
- 搜索面板结构：
  - 容器：`#search-overlay`（遮罩），`#search-results`（结果列表），`#global-search-input`（输入框）。
  - 状态：空结果、加载、错误提示。
- 交互：输入 300ms 防抖请求 `/api/search`；点击结果项跳转并打开对应笔记。
- 样式：在 `public/styles.css` 中新增 `.search-overlay`、`.search-panel`、`.search-item` 等样式。

附件检索
--------

- 支持匹配 `@editorjs/attaches` 的 `file.name` 与 `file.url` 的文件名。
- 支持匹配图片块的 `caption` 与 `file.url` 的文件名。

升级路线（v2 展望）
------------------

- 采用 SQLite FTS5：建立虚表，使用 `bm25` 排名与 `snippet()` 高亮。
- 使用触发器保持 FTS 索引与主表同步；一次性回填历史数据。
- 如需更佳中文分词，后续可评估接入预分词或 ICU。

涉及文件变更
------------

- `src/db.js`：新增 `content_text` 字段与迁移。
- `src/server.js`：
  - 新增 Editor.js 摊平与 HTML 去噪工具函数
  - 启动时回填 `content_text`
  - 保存接口更新 `content_text`
  - 新增 `GET /api/search` 接口
- `public/index.html`：添加搜索按钮与搜索面板 DOM。
- `public/styles.css`：添加搜索面板相关样式。
- `public/app.js`：新增搜索打开/关闭、输入防抖、结果渲染与安全高亮。

使用指南
--------

1. 启动服务后，按 Ctrl/⌘+K 打开搜索面板。
2. 输入关键字后等待结果（防抖 300ms）；点击结果可直接打开对应笔记。
3. 编辑并保存笔记后，`content_text` 会自动更新并参与下次检索。

已知限制（v1）
--------------

- LIKE 检索对中文未做分词，长文本排序与相关性较弱；建议在 v2 引入 FTS5 优化。
- `snippet` 仅取首个命中周边的简单片段，复杂高亮待 v2 优化。


