## 图像功能（Editor.js Image Tool）集成说明

### 概述
为编辑器新增图像块功能，集成了 Editor.js 的 Image Tool，支持从本地上传、粘贴 URL、拖拽与粘贴板图片，后端提供鉴权上传接口并将文件保存到 `public/uploads/`，前端以相对路径引用。

### 前端改动
- **引入插件脚本**：在 `public/index.html` 加载 Image Tool 脚本，并纳入启动时的插件完整性检查。

```15:25:e:\workspace\QNotes\public\index.html
<script src="https://cdn.jsdelivr.net/npm/@editorjs/image@latest/dist/bundle.js"></script>
// ...
const requiredPlugins = ['EditorJS', 'Header', 'Paragraph', 'Checklist', 'Quote', 'Delimiter', 'ImageTool'];
```

- **允许 image 块类型**：加载笔记数据时不过滤掉 `image` 类型。

```286:296:e:\workspace\QNotes\public\app.js
data.blocks = data.blocks.filter(block => {
  return block.type === 'header' || block.type === 'paragraph' ||
         block.type === 'checklist' || block.type === 'quote' ||
         block.type === 'delimiter' || block.type === 'image';
});
```

- **配置 Image 工具与上传器**：在 `setupEditor()` 的 `tools` 中加入 `image`，并使用自定义 `uploader` 调用后端接口。

```667:714:e:\workspace\QNotes\public\app.js
image: {
  class: window.ImageTool,
  config: {
    captionPlaceholder: '添加说明',
    features: { border: true, caption: true, stretch: true },
    uploader: {
      uploadByFile(file) {
        const formData = new FormData();
        formData.append('image', file);
        return request('/uploadFile', { method: 'POST', body: formData })
          .then(res => ({ success: 1, file: { url: res.file.url } }));
      },
      uploadByUrl(url) {
        return request('/fetchUrl', { method: 'POST', body: { url } })
          .then(res => ({ success: 1, file: { url: res.file.url } }));
      }
    }
  }
}
```

### 后端改动
- **依赖**：新增 `multer` 作为接收 multipart/form-data 的中间件。
  - `package.json`：`"multer": "^1.4.5-lts.1"`

- **上传目录**：启动时确保 `public/uploads/` 存在，静态资源可直接以 `/uploads/<filename>` 访问。

```13:28:e:\workspace\QNotes\src\server.js
const fs = require('fs');
const multer = require('multer');
const UPLOAD_DIR = path.join(__dirname, '..', 'public', 'uploads');
if (!fs.existsSync(UPLOAD_DIR)) fs.mkdirSync(UPLOAD_DIR, { recursive: true });
```

- **接口（均需鉴权）**：
  - `POST /api/uploadFile`：表单字段名 `image`，成功返回 `{ success: 1, file: { url } }`。
  - `POST /api/fetchUrl`：请求体 `{ url }`，后端下载到 `uploads/` 后返回同样格式。

```300:343:e:\workspace\QNotes\src\server.js
app.post('/api/uploadFile', authenticate, upload.single('image'), (req, res) => {
  const publicUrl = `/uploads/${req.file.filename}`;
  res.json({ success: 1, file: { url: publicUrl, name: req.file.originalname, size: req.file.size } });
});

app.post('/api/fetchUrl', authenticate, async (req, res) => {
  // 下载 http/https 资源到 uploads/ 并返回 { success: 1, file: { url } }
});
```

### 使用说明
- 在编辑器中点击 “+” 选择「图片」，支持：
  - 本地选择文件上传
  - 直接粘贴图片 URL（后端下载并保存）
  - 拖拽图片或从剪贴板粘贴
- 图片说明（caption）、边框、背景与拉伸可在工具设置中切换。

### 存储与访问
- 存储位置：`public/uploads/`
- 访问路径：`/uploads/<文件名>`（相对站点根路径）

### 接口约定
- 通用成功响应（两种上传方式一致）：

```json
{
  "success": 1,
  "file": { "url": "/uploads/xxxxxx.png" }
}
```

- 失败示例：

```json
{ "error": "错误信息" }
```

### 权限与安全
- 两个上传接口均走现有 `Authorization: Bearer <token>` 鉴权链路。
- 当前版本对文件类型采用“按 content-type/扩展名推断”，生产可进一步加强：
  - 白名单 MIME/扩展名校验（仅 `image/*` 或特定 `video/*`）
  - 限制最大文件尺寸
  - 隔离持久化存储或使用对象存储（S3、OSS 等）

### 排障建议
- 「Image 插件未加载」：检查 `index.html` 的 CDN 脚本与网络连通性。
- 返回 401：确认前端请求携带有效 JWT（已登录）。
- 图片 404：确认 `public/uploads/` 已创建且文件确实生成。
- URL 拉取失败：目标地址是否可公网访问、协议仅支持 http/https。

### 依赖版本
- multer: ^1.4.5-lts.1
- @editorjs/image：通过 CDN `@latest` 引入

### 参考
- Editor.js Image Tool 文档：`https://github.com/editor-js/image`


