## QNotes 自动保存与安全保存说明

### 背景与目标
- 解决用户未点击“保存”时，因切换笔记、刷新/关闭页面、登出等导致内容丢失的问题。
- 在不改变现有手动保存流程的前提下，新增自动保存与防丢失机制，并提供清晰的保存状态指示。

### 功能清单（本次新增）
- 自动保存：默认每 60 秒保存一次，仅当内容有变更（脏）时执行。
- 脏状态标记：接入 EditorJS `onChange` 与标题输入事件，实时标记笔记为“已修改”。
- 保存指示灯：
  - 绿色（status-ok）：正常/已就绪/已保存。
  - 橙色（status-saving）：保存中（手动保存或自动保存）。
  - 红色（status-error）：保存失败，保持红色直到下次保存成功。
- 切换笔记前提示：若有未保存更改，弹窗询问是否保存当前笔记。
- 页面刷新/关闭提示：如有未保存更改，通过 `beforeunload` 提示；在 `visibilitychange` 为隐藏时尝试静默保存（若开启自动保存）。
- 登出前提示：若有未保存更改，弹窗询问是否保存。
- 自动保存开关：在编辑器工具栏提供开关，状态持久化至 `localStorage`。

### UI 变化
- 在编辑器头部新增：
  - 保存指示灯与文案（已就绪/保存中/保存失败）。
  - 自动保存开关（checkbox），默认开启，状态存储于 `localStorage:qnotes_autosave`。

### 主要文件与改动点
- `public/index.html`
  - 在 `.editor-actions` 中新增保存指示灯与自动保存开关：
    - `#save-indicator`、`#save-status-text`、`#autosave-toggle`。
- `public/styles.css`
  - 新增样式：`.save-status`、`.save-indicator`（含 `status-ok`/`status-saving`/`status-error`）、`.save-status-text`、`.autosave-toggle`。
- `public/app.js`
  - 新增状态：`isDirty`、`autosaveTimer`、`autosaveEnabled`、`isSaving`、`lastSaveHadError`。
  - 新增方法：
    - `setSaveIndicator(status, text)`：统一更新指示灯与状态文案。
    - `markDirty()` / `resetDirtyFlag()`：管理脏状态。
    - `persistNote({ silent, reason })`：抽象保存逻辑；保存前复位脏标记，失败时回滚；控制指示灯；支持静默（不打断用户）。
    - `startAutosaveTimer()` / `stopAutosaveTimer()`：管理 60s 自动保存周期。
  - 改动点：
    - `setupEditor()`：EditorJS `onChange` 调用 `markDirty()`。
    - `selectNote(...)`：切换笔记前如 `isDirty` 则询问保存；选择后加载新笔记并复位指示。
    - `loadNote(...)`：渲染后复位脏标记，恢复指示灯为“已就绪”。
    - `startEditing()` / `stopEditing()`：启动/清理自动保存定时器。
    - `saveNote()`：改为调用 `persistNote()`，统一保存入口与指示灯管理。
    - `setupEventListeners()`：
      - 监听标题输入，触发 `markDirty()`。
      - 初始化与变更自动保存开关（持久化 `localStorage:qnotes_autosave`）。
      - `beforeunload`：有未保存更改时提示；仍发送解锁 beacon。
      - `visibilitychange`：页面隐藏时，若开启自动保存且为脏，则静默保存。

### 触发保存的时机
- 自动保存：每 60 秒触发一次，仅当 `isDirty===true`、当前在编辑、且有选中笔记。
- 手动保存：用户点击“保存”。
- 切换笔记：如 `isDirty`，先询问是否保存当前笔记。
- 登出：如 `isDirty`，先询问是否保存当前笔记。
- 页面可见性变化：隐藏时尝试静默保存（开启自动保存时）。

### 后端接口
- 复用既有接口：`PUT /api/notes/:id` 保存标题与 EditorJS 内容 JSON。
- 无需新增后端端点；失败时前端会维持指示灯红色并提示。

### 使用说明
- 编辑任意内容或标题后，指示灯文案显示“有未保存更改”。
- 自动保存默认开启，可通过开关关闭/开启，状态会被记住。
- 保存失败（网络/服务器异常）时指示灯保持红色，下一次保存成功会恢复绿色。

### 兼容与降级
- `beforeunload` 在部分浏览器有交互限制，已通过 `visibilitychange` 进行补偿保存。
- 自动保存仅在编辑中、且笔记已选中时有效，避免无意义请求。

### 测试建议
- 键入文字后等待 60s，观察是否自动保存成功与指示灯变化。
- 切换笔记、登出、刷新/关闭页面时是否提示保存或静默保存成功。
- 网络断开/恢复后，指示灯从红色在成功保存后是否恢复绿色。

### 未来可拓展
- 增加“上次保存时间”展示与更细粒度的错误重试机制。
- 离线缓存更完整的草稿（IndexedDB）与上线同步策略。

